# 网络层

网络层的目的就是使用IP协议，将物理网络连接起来，使得在网络层看起来像一个整体的网络。

IP协议配套的三个协议

- 地址解析协议 ARP（Address Resolution Protocol）
- 网际控制报文协议 ICMP（Internet Control Message Protocol）
- 网际组管理协议 IGMP（Internet Group Management Protocol）



## 1.	地址解析协议ARP

两台主机通信时，IP地址是不变的，但是MAC地址随着链路的改变而变化。

![img](D:\Blog\My-Blog\image\network01_1)



**ARP协议是由IP地址获取MAC地址**



![image-20220314205331825](D:\Blog\My-Blog\image\network01_2)



每一个主机都有自己的ARP缓存，里边有该局域网中的主机和MAC地址的映射。每个主机可通过广播的方式获取其余主机的MAC地址。



## 2.	网际控制报文协议ICMP

ICMP是一个“错误侦报机制”协议，目的就是为了检测网络连通性。



ICMP可分为差错报告和询问报告

| ICMP报文种类 | 类型的值 | ICMP报文的类型   |
| ------------ | :------: | ---------------- |
| 差错报告报文 |    3     | 终点不可达       |
| 差错报告报文 |    11    | 时间超过         |
| 差错报告报文 |    12    | 参数问题         |
| 差错报告报文 |    5     | 改变路由         |
| 询问报文     | 8 or 10  | 回送请求或回答   |
| 询问报文     | 13 or 14 | 时间戳请求或回答 |



### 2.1	应用--Ping

ping主要用于测试两台主机的连通性，通过发送询问报文，目的主机收到后回送应答报文，ping会根据时间和成功相应的次数来判断丢包率。



### 2.2	应用--Traceroute

traceroute用来跟踪源到目的节点的路径。



## 3.	路由转发算法

1. 从数据报的首部提取目的主机的地址N
2. 若 N 就是与此路由器直接相连的某个网络地址，则进行直接交付，否则执行3
3. 若路由表中有目的地址为N的特定主机路由，则把数据报传送给表中所指明的下一跳路由器，否则执行4
4. 逐条检查路由表。若找到匹配路由，则按照路由表进行转发：若所有路由均不匹配，否则执行5
5. 若路由表中设置有默认路由，则按照默认路由表转发：否则执行6
6. 向源主机报错



## 4.	路由选择协议

路由选择协议都是自适应的，能随着网络通信量和拓扑结构的变化而自适应地进行调整。

互联网可以划分为许多较小的自治系统 AS，一个 AS 可以使用一种和别的 AS 不同的路由选择协议。

可以把路由选择协议划分为两大类：

- 自治系统内部的路由选择：RIP 和 OSPF
- 自治系统间的路由选择：BGP



### 4.1	内部网关协议 RIP

RIP 是一种基于距离向量的路由选择协议。距离是指跳数，直接相连的路由器跳数为 1。跳数最多为 15，超过 15 表示不可达。

RIP 按固定的时间间隔仅和相邻路由器交换自己的路由表，经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址。

距离向量算法：

- 对地址为 X 的相邻路由器发来的 RIP 报文，先修改报文中的所有项目，把下一跳字段中的地址改为 X，并把所有的距离字段加 1；
- 对修改后的 RIP 报文中的每一个项目，进行以下步骤：
- 若原来的路由表中没有目的网络 N，则把该项目添加到路由表中；
- 否则：若下一跳路由器地址是 X，则把收到的项目替换原来路由表中的项目；否则：若收到的项目中的距离 d 小于路由表中的距离，则进行更新（例如原始路由表项为 Net2, 5, P，新表项为 Net2, 4, X，则更新）；否则什么也不做。
- 若 3 分钟还没有收到相邻路由器的更新路由表，则把该相邻路由器标为不可达，即把距离置为 16。

RIP 协议实现简单，开销小。但是 RIP 能使用的最大距离为 15，限制了网络的规模。并且当网络出现故障时，要经过比较长的时间才能将此消息传送到所有路由器。



### 4.2	内部网关协议 OSPF

开放最短路径优先 OSPF，是为了克服 RIP 的缺点而开发出来的。

开放表示 OSPF 不受某一家厂商控制，而是公开发表的；最短路径优先表示使用了 Dijkstra 提出的最短路径算法 SPF。

OSPF 具有以下特点：

- 向本自治系统中的所有路由器发送信息，这种方法是洪泛法。
- 发送的信息就是与相邻路由器的链路状态，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示。
- 只有当链路状态发生变化时，路由器才会发送信息。

所有路由器都具有全网的拓扑结构图，并且是一致的。相比于 RIP，OSPF 的更新过程收敛的很快。



### 4.3	外部网关协议 BGP

BGP（Border Gateway Protocol，边界网关协议）

AS 之间的路由选择很困难，主要是由于：

- 互联网规模很大；
- 各个 AS 内部使用不同的路由选择协议，无法准确定义路径的度量；
- AS 之间的路由选择必须考虑有关的策略，比如有些 AS 不愿意让其它 AS 经过。

BGP 只能寻找一条比较好的路由，而不是最佳路由。

每个 AS 都必须配置 BGP 发言人，通过在两个相邻 BGP 发言人之间建立 TCP 连接来交换路由信息。